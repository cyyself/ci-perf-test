name: Use the data

on:
  workflow_run:
    workflows: [Upload data]
    types:
      - completed

jobs:
  use-artifact:
    runs-on: ubuntu-24.04
    steps:
      - name: Download artifact
        uses: actions/github-script@v8
        with:
          script: |
            const artifactName = 'hello-artifact';
            const prNumber = github.event.workflow_run.pull_requests[0]?.number || 'no-pr';
            const artifactClient = github.actions.artifacts;
            const artifacts = await artifactClient.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const artifact = artifacts.data.artifacts.find(a => a.name === artifactName);
            if (!artifact) {
              core.setFailed(`Artifact ${artifactName} not found`);
              return;
            }
            const downloadResponse = await artifactClient.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: artifact.id,
              archive_format: 'zip',
            });
            const fs = require('fs');
            const path = require('path');
            const unzipper = require('unzipper');
            const extractPath = path.join(process.cwd(), `artifact-${prNumber}`);
            fs.mkdirSync(extractPath, { recursive: true });
            const buffer = Buffer.from(await downloadResponse.data.arrayBuffer());
            const stream = unzipper.Extract({ path: extractPath });
            stream.on('close', () => {
              console.log(`Artifact extracted to ${extractPath}`);
            });
            stream.end(buffer);
      - name: Read the file
        run: |
          PR_NUMBER=${{ github.event.workflow_run.pull_requests[0]?.number || 'no-pr' }}
          cat artifact-${PR_NUMBER}/${PR_NUMBER}.txt
          # TODO: Comment on the PR with the content of the file